"use strict";(self.webpackChunkalova_website=self.webpackChunkalova_website||[]).push([[9721],{56626:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>s,metadata:()=>i,toc:()=>d});var r=n(85893),a=n(11151);n(74866),n(85162);const s={title:"Request Middleware"},o=void 0,i={id:"tutorial/client/in-depth/middleware",title:"Request Middleware",description:"Client useHook",source:"@site/docs/tutorial/03-client/02-in-depth/03-middleware.md",sourceDirName:"tutorial/03-client/02-in-depth",slug:"/tutorial/client/in-depth/middleware",permalink:"/next/tutorial/client/in-depth/middleware",draft:!1,unlisted:!1,editUrl:"https://github.com/alovajs/alovajs.github.io/blob/main/docs/tutorial/03-client/02-in-depth/03-middleware.md",tags:[],version:"current",sidebarPosition:3,frontMatter:{title:"Request Middleware"},sidebar:"tutorial",previous:{title:"Method Matcher",permalink:"/next/tutorial/client/in-depth/method-matcher"},next:{title:"Manage Extra states",permalink:"/next/tutorial/client/in-depth/manage-extra-states"}},l={},d=[{value:"Middleware function",id:"middleware-function",level:2},{value:"Ignore requests",id:"ignore-requests",level:2},{value:"Control response data",id:"control-response-data",level:2},{value:"Change request",id:"change-request",level:2},{value:"Control errors",id:"control-errors",level:2},{value:"Capture errors",id:"capture-errors",level:3},{value:"Throw an error",id:"throw-an-error",level:3},{value:"Control response delay",id:"control-response-delay",level:2},{value:"More than that",id:"more-than-that",level:2},{value:"Request information included",id:"request-information-included",level:2},{value:"Modify responsive data",id:"modify-responsive-data",level:2},{value:"Interrupt or repeat request",id:"interrupt-or-repeat-request",level:2},{value:"Controlled loading state",id:"controlled-loading-state",level:2}];function c(e){const t={a:"a",admonition:"admonition",code:"code",em:"em",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,a.a)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(t.admonition,{title:"Usage scope",type:"info",children:(0,r.jsx)(t.p,{children:"Client useHook"})}),"\n",(0,r.jsx)(t.p,{children:"You can set request middleware for all useHooks to freely control request behavior, providing powerful capabilities that can control almost all behaviors of a request. Whether it is a simple or complex request strategy, you may use it. Next, let's see what it can do."}),"\n",(0,r.jsx)(t.h2,{id:"middleware-function",children:"Middleware function"}),"\n",(0,r.jsx)(t.p,{children:"Request middleware is an asynchronous function. The following is a simple request middleware that prints some information before and after the request, without changing any request behavior."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"useRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    console.log('before request');\n    await next();\n    console.log('after requeste');\n  }\n});\n"})}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"next"})," function is an asynchronous function. Calling it will continue to send requests. At this time, the ",(0,r.jsx)(t.em,{children:"loading"})," state will be set to true, and then the request will be sent. The return value of next is a Promise instance with response data. You can manipulate the return value in the middleware function."]}),"\n",(0,r.jsx)(t.h2,{id:"ignore-requests",children:"Ignore requests"}),"\n",(0,r.jsxs)(t.p,{children:["When you don't want to make a request, you can ignore the request by not calling ",(0,r.jsx)(t.code,{children:"next"}),", as if the request has never been made. For example, do not make a request when a listening field changes in ",(0,r.jsx)(t.code,{children:"useWatcher"}),"."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-js",children:"useWatcher(() => todoList(), [state1], {\n  middleware: async (_, next) => {\n    if (state1 === 'a') {\n      return next();\n    }\n  }\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"control-response-data",children:"Control response data"}),"\n",(0,r.jsxs)(t.p,{children:["The return value of the middleware function will be used as the response data of this request for subsequent processing. If the middleware does not return any data but calls ",(0,r.jsx)(t.code,{children:"next"}),", the response data of this request will be used for subsequent processing."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"// Convert response data and return\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    const result = await next();\n    result.code = 500;\n    return result;\n  }\n});\n\n// The response data of this request will be used for subsequent processing\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    await next();\n  }\n});\n\n// The string abc will be used as the response data\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    await next();\n    return 'abc';\n  }\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"change-request",children:"Change request"}),"\n",(0,r.jsxs)(t.p,{children:["Sometimes you want to change the request. At this time, you can specify another method instance in ",(0,r.jsx)(t.code,{children:"next"}),". When sending the request, the information in this method will be requested. At the same time, you can also use ",(0,r.jsx)(t.code,{children:"next"})," to set whether to force the request to penetrate the cache. This is also very simple."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"useRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    await next({\n      // Change the method instance of the request\n      method: newMethodInstance,\n\n      // Force the request this time\n      force: true\n    });\n  }\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"control-errors",children:"Control errors"}),"\n",(0,r.jsx)(t.h3,{id:"capture-errors",children:"Capture errors"}),"\n",(0,r.jsxs)(t.p,{children:["In the middleware, you can capture the request error generated in ",(0,r.jsx)(t.code,{children:"next"}),". After capturing, the global ",(0,r.jsx)(t.code,{children:"onError"})," hook will no longer be triggered."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"useRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    try {\n      await next();\n    } catch (e) {\n      console.error('Caught error', e);\n    }\n  }\n});\n"})}),"\n",(0,r.jsx)(t.h3,{id:"throw-an-error",children:"Throw an error"}),"\n",(0,r.jsx)(t.p,{children:"Of course, you can also throw a custom error in the middleware, and even if the request is normal, it will enter the request error process."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"// No request is sent, and global and request-level onError will be triggered. If the request is sent through `method.send`, a reject promise instance will be returned\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    throw new Error('error on before request');\n    await next();\n  }\n});\n\n// After the request is successful, global and request-level onError will be triggered. If the request is sent through `method.send`, a reject promise instance will be returned\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    await next();\n    throw new Error('error on after request');\n  }\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"control-response-delay",children:"Control response delay"}),"\n",(0,r.jsx)(t.p,{children:"In the middleware, we can delay the response or respond in advance. In the case of early response, although the response data cannot be obtained, some other data can be returned as response data to participate in subsequent processing."}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"// Delay response for 1 second\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    await new Promise(resolve => {\n      setTimeout(resolve, 1000);\n    });\n    return next();\n  }\n});\n\n// Respond immediately and use string abc as response data\nuseRequest(todoList, {\n  async middleware(_, \u200b\u200bnext) {\n    return 'abc';\n  }\n});\n"})}),"\n",(0,r.jsx)(t.h2,{id:"more-than-that",children:"More than that"}),"\n",(0,r.jsxs)(t.p,{children:["**So far, we have mentioned the use of the second parameter ",(0,r.jsx)(t.code,{children:"next"})," of the middleware, so what does the first parameter do? **"]}),"\n",(0,r.jsxs)(t.p,{children:["The first parameter of the middleware contains some information about this request, as well as control functions for the status and events returned in useHook such as ",(0,r.jsx)(t.code,{children:"loading"}),", ",(0,r.jsx)(t.code,{children:"data"})," and ",(0,r.jsx)(t.code,{children:"onSuccess"}),". Let's continue to look down!"]}),"\n",(0,r.jsx)(t.h2,{id:"request-information-included",children:"Request information included"}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"async function middleware(context, next) {\n  // Method instance for this request\n  context.method;\n\n  // Parameter array sent by the send function, default is []\n  context.args;\n\n  // Cache data hit by this request\n  context.cachedResponse;\n\n  // Configuration collection of useHook\n  context.config;\n\n  // The various states returned by useHook, it is a state proxy, including the following properties\n  // loading, data, error, downloading, uploading, and additional states managed by managedStates\n  context.proxyStates;\n\n  // Operation function in current useHook, send, abort\n  // context.fetch in useFetcher\n  context.send;\n  context.abort;\n}\n"})}),"\n",(0,r.jsx)(t.p,{children:"Next, let's take a look at what control capabilities are available."}),"\n",(0,r.jsx)(t.h2,{id:"modify-responsive-data",children:"Modify responsive data"}),"\n",(0,r.jsxs)(t.p,{children:["Use ",(0,r.jsx)(t.code,{children:"context.proxyStates"})," to modify the state data of the current useHook. Since alova's useHook is compatible with multiple UI frameworks, proxyStates is a unified state proxy, which is used in a similar way to vue's ref value."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"async function middleware(context, next) {\n  const { loading, data } = context.proxyStates;\n\n  // Get loading value\n  const loadingValue = loading.v;\n  // Change loading status to true\n  loading.v = true;\n\n  // Modify data status value\n  data.v = {\n    /* ... */\n  };\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["For detailed usage of state proxy, please refer to ",(0,r.jsx)(t.a,{href:"/next/tutorial/advanced/custom/client-strategy",children:"State Proxy"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"interrupt-or-repeat-request",children:"Interrupt or repeat request"}),"\n",(0,r.jsxs)(t.p,{children:["The ",(0,r.jsx)(t.code,{children:"abort"})," and ",(0,r.jsx)(t.code,{children:"send"})," functions (",(0,r.jsx)(t.code,{children:"fetch"})," in useFetcher) received by the middleware can also send multiple requests when a request intent is triggered."]}),"\n",(0,r.jsxs)(t.p,{children:["A typical use case is request retry. If a request fails after sending a request, it will automatically request again according to a certain strategy. After the retry succeeds, it will trigger ",(0,r.jsx)(t.code,{children:"onSuccess"}),". The following is a simple request retry example code."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"async function middleware(context, next) {\n  return next().catch(error => {\n    if (needRetry) {\n      setTimeout(() => {\n        context.send(...context.sendArgs);\n      }, retryDelay);\n    }\n    return Promise.reject(error);\n  });\n}\n"})}),"\n",(0,r.jsxs)(t.p,{children:["If you need to interrupt the request in the middleware, you can call ",(0,r.jsx)(t.code,{children:"context.abort()"}),"."]}),"\n",(0,r.jsx)(t.h2,{id:"controlled-loading-state",children:"Controlled loading state"}),"\n",(0,r.jsxs)(t.p,{children:["In the above content, we know that we can modify responsive data through ",(0,r.jsx)(t.code,{children:"loading.v"}),", but there will be obstacles when you modify the loading state value ",(0,r.jsx)(t.code,{children:"loading"}),", because under normal circumstances, the loading state value will be automatically set to true when calling ",(0,r.jsx)(t.code,{children:"next"}),", and automatically set to false in the response process, which will overwrite the loading state value modified by ",(0,r.jsx)(t.code,{children:"loading.v"}),". At this time, we can turn on the controlled loading state. After turning it on, the loading state value will no longer be modified in the ",(0,r.jsx)(t.code,{children:"next"})," function and the response process, and we will be fully controlled."]}),"\n",(0,r.jsx)(t.p,{children:"Let's take request retry as an example. We hope that the loading state will remain true from the beginning of triggering a request intention, through request retry until the request ends."}),"\n",(0,r.jsxs)(t.p,{children:["Use ",(0,r.jsx)(t.code,{children:"context.controlLoading"})," to turn on the custom control loading state."]}),"\n",(0,r.jsx)(t.pre,{children:(0,r.jsx)(t.code,{className:"language-javascript",children:"async function middleware(context, next) {\n  context.controlLoading();\n  const { loading } = context.proxyStates;\n\n  // Set to true when the request starts\n  loading.v = true;\n  return next()\n    .then(value => {\n      // Set to false after the request is successful\n      loading.v = false;\n      return value;\n    })\n    .catch(error => {\n      if (needRetry) {\n        setTimeout(() => {\n          context.send(...context.sendArgs);\n        }, retryDelay);\n      } else {\n        // Set to false when no longer retrying\n        loading.v = false;\n      }\n      return Promise.reject(error);\n    });\n}\n"})})]})}function u(e={}){const{wrapper:t}={...(0,a.a)(),...e.components};return t?(0,r.jsx)(t,{...e,children:(0,r.jsx)(c,{...e})}):c(e)}},85162:(e,t,n)=>{n.d(t,{Z:()=>o});n(67294);var r=n(90512);const a={tabItem:"tabItem_Ymn6"};var s=n(85893);function o(e){let{children:t,hidden:n,className:o}=e;return(0,s.jsx)("div",{role:"tabpanel",className:(0,r.Z)(a.tabItem,o),hidden:n,children:t})}},74866:(e,t,n)=>{n.d(t,{Z:()=>j});var r=n(67294),a=n(90512),s=n(12466),o=n(16550),i=n(20469),l=n(91980),d=n(67392),c=n(20812);function u(e){return r.Children.toArray(e).filter((e=>"\n"!==e)).map((e=>{if(!e||(0,r.isValidElement)(e)&&function(e){const{props:t}=e;return!!t&&"object"==typeof t&&"value"in t}(e))return e;throw new Error(`Docusaurus error: Bad <Tabs> child <${"string"==typeof e.type?e.type:e.type.name}>: all children of the <Tabs> component should be <TabItem>, and every <TabItem> should have a unique "value" prop.`)}))?.filter(Boolean)??[]}function h(e){const{values:t,children:n}=e;return(0,r.useMemo)((()=>{const e=t??function(e){return u(e).map((e=>{let{props:{value:t,label:n,attributes:r,default:a}}=e;return{value:t,label:n,attributes:r,default:a}}))}(n);return function(e){const t=(0,d.l)(e,((e,t)=>e.value===t.value));if(t.length>0)throw new Error(`Docusaurus error: Duplicate values "${t.map((e=>e.value)).join(", ")}" found in <Tabs>. Every value needs to be unique.`)}(e),e}),[t,n])}function p(e){let{value:t,tabValues:n}=e;return n.some((e=>e.value===t))}function m(e){let{queryString:t=!1,groupId:n}=e;const a=(0,o.k6)(),s=function(e){let{queryString:t=!1,groupId:n}=e;if("string"==typeof t)return t;if(!1===t)return null;if(!0===t&&!n)throw new Error('Docusaurus error: The <Tabs> component groupId prop is required if queryString=true, because this value is used as the search param name. You can also provide an explicit value such as queryString="my-search-param".');return n??null}({queryString:t,groupId:n});return[(0,l._X)(s),(0,r.useCallback)((e=>{if(!s)return;const t=new URLSearchParams(a.location.search);t.set(s,e),a.replace({...a.location,search:t.toString()})}),[s,a])]}function f(e){const{defaultValue:t,queryString:n=!1,groupId:a}=e,s=h(e),[o,l]=(0,r.useState)((()=>function(e){let{defaultValue:t,tabValues:n}=e;if(0===n.length)throw new Error("Docusaurus error: the <Tabs> component requires at least one <TabItem> children component");if(t){if(!p({value:t,tabValues:n}))throw new Error(`Docusaurus error: The <Tabs> has a defaultValue "${t}" but none of its children has the corresponding value. Available values are: ${n.map((e=>e.value)).join(", ")}. If you intend to show no default tab, use defaultValue={null} instead.`);return t}const r=n.find((e=>e.default))??n[0];if(!r)throw new Error("Unexpected error: 0 tabValues");return r.value}({defaultValue:t,tabValues:s}))),[d,u]=m({queryString:n,groupId:a}),[f,x]=function(e){let{groupId:t}=e;const n=function(e){return e?`docusaurus.tab.${e}`:null}(t),[a,s]=(0,c.Nk)(n);return[a,(0,r.useCallback)((e=>{n&&s.set(e)}),[n,s])]}({groupId:a}),g=(()=>{const e=d??f;return p({value:e,tabValues:s})?e:null})();(0,i.Z)((()=>{g&&l(g)}),[g]);return{selectedValue:o,selectValue:(0,r.useCallback)((e=>{if(!p({value:e,tabValues:s}))throw new Error(`Can't select invalid tab value=${e}`);l(e),u(e),x(e)}),[u,x,s]),tabValues:s}}var x=n(72389);const g={tabList:"tabList__CuJ",tabItem:"tabItem_LNqP"};var w=n(85893);function v(e){let{className:t,block:n,selectedValue:r,selectValue:o,tabValues:i}=e;const l=[],{blockElementScrollPositionUntilNextRender:d}=(0,s.o5)(),c=e=>{const t=e.currentTarget,n=l.indexOf(t),a=i[n].value;a!==r&&(d(t),o(a))},u=e=>{let t=null;switch(e.key){case"Enter":c(e);break;case"ArrowRight":{const n=l.indexOf(e.currentTarget)+1;t=l[n]??l[0];break}case"ArrowLeft":{const n=l.indexOf(e.currentTarget)-1;t=l[n]??l[l.length-1];break}}t?.focus()};return(0,w.jsx)("ul",{role:"tablist","aria-orientation":"horizontal",className:(0,a.Z)("tabs",{"tabs--block":n},t),children:i.map((e=>{let{value:t,label:n,attributes:s}=e;return(0,w.jsx)("li",{role:"tab",tabIndex:r===t?0:-1,"aria-selected":r===t,ref:e=>l.push(e),onKeyDown:u,onClick:c,...s,className:(0,a.Z)("tabs__item",g.tabItem,s?.className,{"tabs__item--active":r===t}),children:n??t},t)}))})}function b(e){let{lazy:t,children:n,selectedValue:a}=e;const s=(Array.isArray(n)?n:[n]).filter(Boolean);if(t){const e=s.find((e=>e.props.value===a));return e?(0,r.cloneElement)(e,{className:"margin-top--md"}):null}return(0,w.jsx)("div",{className:"margin-top--md",children:s.map(((e,t)=>(0,r.cloneElement)(e,{key:t,hidden:e.props.value!==a})))})}function y(e){const t=f(e);return(0,w.jsxs)("div",{className:(0,a.Z)("tabs-container",g.tabList),children:[(0,w.jsx)(v,{...t,...e}),(0,w.jsx)(b,{...t,...e})]})}function j(e){const t=(0,x.Z)();return(0,w.jsx)(y,{...e,children:u(e.children)},String(t))}},11151:(e,t,n)=>{n.d(t,{Z:()=>i,a:()=>o});var r=n(67294);const a={},s=r.createContext(a);function o(e){const t=r.useContext(s);return r.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function i(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:o(e.components),r.createElement(s.Provider,{value:t},e.children)}}}]);