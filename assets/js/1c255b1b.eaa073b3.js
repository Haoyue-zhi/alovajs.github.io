"use strict";(self.webpackChunkalova_website=self.webpackChunkalova_website||[]).push([[2295],{1943:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>i,contentTitle:()=>c,default:()=>d,frontMatter:()=>o,metadata:()=>a,toc:()=>l});var s=n(5893),r=n(1151);const o={title:"Controlled Cache",sidebar_position:60},c=void 0,a={id:"tutorial/cache/controlled-cache",title:"Controlled Cache",description:"v2.1.0+",source:"@site/docs/tutorial/04-cache/06-controlled-cache.md",sourceDirName:"tutorial/04-cache",slug:"/tutorial/cache/controlled-cache",permalink:"/tutorial/cache/controlled-cache",draft:!1,unlisted:!1,editUrl:"https://github.com/alovajs/alovajs.github.io/blob/main/docs/tutorial/04-cache/06-controlled-cache.md",tags:[],version:"current",sidebarPosition:60,frontMatter:{title:"Controlled Cache",sidebar_position:60},sidebar:"tutorialSidebar",previous:{title:"Set & Query Cache",permalink:"/tutorial/cache/set-and-query"},next:{title:"Select next stage",permalink:"/tutorial/strategy/"}},i={},l=[{value:"Do not use caching",id:"do-not-use-caching",level:2},{value:"Use transformData to set up cache",id:"use-transformdata-to-set-up-cache",level:2},{value:"Notes",id:"notes",level:2}];function h(e){const t={admonition:"admonition",code:"code",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(t.admonition,{title:"version requirements",type:"info",children:(0,s.jsx)(t.p,{children:"v2.1.0+"})}),"\n",(0,s.jsxs)(t.p,{children:["When sending a request, by default it will first check whether there is matching cache data. If it matches, it will use it as the response data to return. If in some scenarios, the user needs to use a custom cache, they must first use ",(0,s.jsx)(t.code,{children:"setCache"})," to synchronize Setting up cached data can only work, which undoubtedly increases the burden on users. This is an uncontrolled cache."]}),"\n",(0,s.jsxs)(t.p,{children:["If you want to use ",(0,s.jsx)(t.strong,{children:"IndexedDB"})," to custom manage cached data under uncontrolled caching, you may first pre-set the hit cache for the upcoming request, like this:"]}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",children:"const getFile = fileName => {\r\n  const fileGetter = alovaInstance.GET(`/file/${fileName}`);\r\n  const tx = db.transaction(['files']);\r\n  const getRequest = tx.objectStore('files').get(fileName);\r\n  getRequest.onsuccess = ({ result }) => {\r\n    setCache(fileGetter, result);\r\n  };\r\n  return fileGetter;\r\n};\n"})}),"\n",(0,s.jsxs)(t.p,{children:[(0,s.jsx)(t.strong,{children:"\u274c However, the above writing method is not recommended"})," for the following reasons:"]}),"\n",(0,s.jsxs)(t.ol,{children:["\n",(0,s.jsxs)(t.li,{children:["Each time ",(0,s.jsx)(t.code,{children:"getFile"})," is called, a cache will be set, but fileGetter is not necessarily used to send requests;"]}),"\n",(0,s.jsx)(t.li,{children:"IndexedDB is an asynchronous interface. If the cache matching step occurs before IndexedDB triggers onsuccess, then the cached data will not be matched, and their order is unpredictable;"}),"\n",(0,s.jsx)(t.li,{children:"Custom cache management tasks and methods are separated, but in fact they should be brought together;"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"In this case, you can use controlled caching to solve the above problem. Using controlled caching is also very simple. You can set the localCache in the method to an asynchronous or synchronous function, and return custom data as a hit response."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",children:"const getFile = fileName =>\r\n  alovaInstance.GET(`/file/${fileName}`, {\r\n    // Controlled cache functions support asynchronous and synchronous functions\r\n    localCache() {\r\n      return new Promise((resolve, reject) => {\r\n        const tx = db.transaction(['files']);\r\n        const getRequest = tx.objectStore('files').get(fileName);\r\n        getRequest.onsuccess = resolve;\r\n        getRequest.onerror = reject;\r\n      });\r\n    }\r\n  });\n"})}),"\n",(0,s.jsx)(t.h2,{id:"do-not-use-caching",children:"Do not use caching"}),"\n",(0,s.jsxs)(t.p,{children:["If you wish to continue sending the request, you can return ",(0,s.jsx)(t.code,{children:"undefined"})," or ",(0,s.jsx)(t.code,{children:"void"})," in ",(0,s.jsx)(t.code,{children:"localCache"}),", which is useful in the case of cache misses when customizing the cache."]}),"\n",(0,s.jsx)(t.h2,{id:"use-transformdata-to-set-up-cache",children:"Use transformData to set up cache"}),"\n",(0,s.jsxs)(t.p,{children:["Because the ",(0,s.jsx)(t.code,{children:"transformData"})," function has the following two properties:"]}),"\n",(0,s.jsxs)(t.ul,{children:["\n",(0,s.jsx)(t.li,{children:"It is only triggered when responding, but will not be triggered when the response cache is hit;"}),"\n",(0,s.jsx)(t.li,{children:"Support asynchronous functions;"}),"\n"]}),"\n",(0,s.jsx)(t.p,{children:"Therefore, you can also use it to save customized caches. For example, in a cache scenario where files are used as response data, you can use IndexedDB to cache file data."}),"\n",(0,s.jsx)(t.pre,{children:(0,s.jsx)(t.code,{className:"language-javascript",children:"const fileGetter = alovaInstance.Get('/file/file_name', {\r\n  // Use IndexedDB to cache files\r\n  async transformData(fileBlob) {\r\n    await new Promise((resolve, reject) => {\r\n      const tx = db.transaction(['files'], 'readwrite');\r\n      const putRequest = tx.objectStore('files').put({\r\n        file: fileBlob\r\n      });\r\n      putRequest.onsuccess = resolve;\r\n      putRequest.onerror = reject;\r\n    });\r\n    return fileBlob;\r\n  }\r\n});\n"})}),"\n",(0,s.jsx)(t.h2,{id:"notes",children:"Notes"}),"\n",(0,s.jsxs)(t.p,{children:["When used in usehooks, throwing an error in the ",(0,s.jsx)(t.code,{children:"localCache"})," function will trigger ",(0,s.jsx)(t.code,{children:"onError"}),". When a request is made directly using a method instance, a promise instance with a reject status will be returned."]})]})}function d(e={}){const{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,s.jsx)(t,{...e,children:(0,s.jsx)(h,{...e})}):h(e)}},1151:(e,t,n)=>{n.d(t,{Z:()=>a,a:()=>c});var s=n(7294);const r={},o=s.createContext(r);function c(e){const t=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:c(e.components),s.createElement(o.Provider,{value:t},e.children)}}}]);